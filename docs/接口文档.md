# 《发现你的天赋优势》接口文档

## 一、约定说明

- **Base URL**：开发环境 `http://collect.com/api/v1`（与前端 request.js 一致）；生产环境由部署配置。
- **请求头**：`Content-Type` 见各接口说明；`Authorization` 可选（H5 匿名答题可不传，支付/订单可传 token 或 openid 等）。
- **统一响应**：
  - 成功：`{ "code": 200, "msg": "success", "data": { ... } }`
  - 业务错误：`{ "code": 10000+, "msg": "错误说明" }`
- **文档中路径**：均相对于 Base URL，如 `test-types/list` 即 `GET /api/v1/test-types/list`。

---

## 二、测试类型相关

### 2.1 测试类型列表（首页 4 卡片）

- **路径**：`GET /test-types/list`
- **说明**：返回所有测试类型（含 MBTI、霍兰德、DISC、职业锚），用于首页展示；仅 MBTI 可点时由前端根据 `code` 或 `status`/`is_available` 控制灰色与「即将上线」。
- **请求参数**：无（或可选 `status=1` 只返回启用）。
- **响应示例**：

```json
{
  "code": 200,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "code": "MBTI",
      "name": "MBTI 职业性格测试",
      "description": "简要说明",
      "total_questions": 93,
      "sort": 1,
      "status": 1,
      "price": "8.88",
      "is_available": true
    },
    {
      "id": 2,
      "code": "HOLLAND",
      "name": "霍兰德职业兴趣测试",
      "total_questions": 0,
      "sort": 2,
      "status": 1,
      "price": "8.88",
      "is_available": false
    }
  ]
}
```

- **字段说明**：`price` 为后台可配置单价（元）；`is_available` 为是否已上线可测（v1.0 仅 MBTI 为 true）。

---

## 三、MBTI 题目与说明

### 3.1 MBTI 测试说明（说明页）

- **路径**：`GET /mbti/intro` 或 `GET /test-types/detail?code=MBTI`
- **说明**：获取 MBTI 的说明文案、题数、建议时长等，用于说明页展示。
- **请求参数**：无；或 `code=MBTI`。
- **响应示例**：

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "id": 1,
    "code": "MBTI",
    "name": "MBTI 职业性格测试",
    "description": "测试说明正文...",
    "total_questions": 93,
    "price": "8.88",
    "estimate_minutes": 15
  }
}
```

### 3.2 MBTI 题目列表（答题页）

- **路径**：`GET /mbti/questions`
- **说明**：获取 MBTI 全部题目，按题号排序；选项由后端从 **strengths_test_question_options** 按题组装为数组返回（表结构无 JSON，见《数据库设计》）。
- **请求参数**：无。
- **响应示例**：

```json
{
  "code": 200,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "question_number": 1,
      "question_text": "题目内容",
      "dimension": "EI",
      "options": [
        { "key": "A", "text": "选项 A" },
        { "key": "B", "text": "选项 B" }
      ]
    }
  ]
}
```

- **说明**：`dimension` 为 EI/SN/TF/JP 之一；选项来自 **strengths_test_question_options**（option_key、option_text），计分在后端用 dimension_side（E/I/S/N/T/F/J/P）汇总，前端无需传计分字段。

---

## 四、MBTI 答题与结果

### 4.1 提交答案并获取结果

- **路径**：`POST /mbti/submit`
- **Content-Type**：`application/json` 或 `application/x-www-form-urlencoded`
- **说明**：提交用户答案，后端按《数据库设计》中「MBTI 测试逻辑」计分（用 strengths_test_question_options.dimension_side 汇总），得到 16 型之一，写入 **strengths_test_results_records**；报告内容从 **strengths_test_answer** 按 test_type+result_code 查询；返回结果码与预览内容。
- **请求体示例**：

```json
{
  "answers": [
    { "question_number": 1, "option_key": "A" },
    { "question_number": 2, "option_key": "B" }
  ]
}
```

或按题号顺序：`{ "answers": [ { "question_number": 1, "option_key": "A" }, ... ] }`。后端用 question_number + option_key 在 **strengths_test_question_options** 中取 dimension_side 计分。

- **响应示例**：

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "result_id": 1001,
    "result_code": "INTJ",
    "result_name": "建筑师",
    "preview_content": "免费预览的 30% 内容（核心特征、一句话总结等）",
    "is_paid": false
  }
}
```

- **说明**：同一用户（如 openid）+ 同一设备/会话在未付费前可复用 `result_id`；若该 result 已付费，再次请求可返回 `is_paid: true` 及完整内容标识。

### 4.2 报告详情（预览 / 完整）

- **路径**：`GET /mbti/report?result_id=1001`
- **说明**：根据 `result_id` 返回报告内容；若已付费则返回完整内容，否则仅返回预览部分（约 30%）。
- **请求参数**：`result_id`（必填）。
- **响应示例**（未付费）：

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "result_id": 1001,
    "result_code": "INTJ",
    "result_name": "建筑师",
    "preview_content": "...",
    "full_content": null,
    "is_paid": false,
    "price": "8.88"
  }
}
```

- **响应示例**（已付费）：`full_content` 有值，`is_paid` 为 true；`full_content` 可为 HTML 或结构化 JSON（由前端渲染）。

---

## 五、订单与支付

### 5.1 创建订单（获取支付参数）

- **路径**：`POST /order/create`
- **Content-Type**：`application/json`
- **说明**：根据 **result_id** 创建订单；后端从 strengths_test_results_records 取 test_type、校验未付费与归属，金额从 strengths_test_types（code=test_type）取 price，返回易支付跳转 URL 或支付参数。
- **请求体示例**：

```json
{
  "result_id": 1001
}
```

- **响应示例**：

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "order_id": "ORD202401010001",
    "amount": "8.88",
    "pay_url": "https://xxx/pay?out_trade_no=...",
    "out_trade_no": "xxx"
  }
}
```

- **说明**：前端跳转 `pay_url` 完成支付；支付成功后易支付回调后端，后端更新订单状态并标记该 result 已付费。

### 5.2 支付回调（后端对易支付）

- **说明**：由后端接收易支付异步回调，校验签名、更新订单状态、更新测试结果付费状态；不在此文档规定前端调用。

### 5.3 订单状态 / 是否已付费

- **路径**：`GET /order/status?result_id=1001` 或 `GET /mbti/report?result_id=1001`（报告接口内已含 `is_paid`）
- **说明**：若报告接口已返回 `is_paid`，可不再单独查订单；否则提供本接口用于轮询或进入报告页前校验。
- **响应示例**：

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "result_id": 1001,
    "is_paid": true,
    "order_id": "ORD202401010001"
  }
}
```

---

## 六、用户与微信（可选 v1.0）

### 6.1 微信 H5 授权获取 openid（若使用）

- **路径**：由后端提供授权 URL 或 `GET /wechat/auth-url?redirect_uri=xxx`
- **说明**：前端跳转微信授权页，授权后回调后端，后端用 code 换 openid 并写入 session 或返回给前端；支付时用 openid 防重复付费。
- **具体参数与回调格式**：与易支付、微信开放平台配置一致，由后端开发文档约定。

---

## 七、接口与前端页面对应

| 前端页面 | 主要接口 |
|----------|----------|
| 首页 4 卡片 | `GET /test-types/list` |
| MBTI 说明页 | `GET /mbti/intro` 或 `GET /test-types/detail?code=MBTI` |
| MBTI 答题页 | `GET /mbti/questions`；提交时 `POST /mbti/submit` |
| MBTI 结果预览页 | `GET /mbti/report?result_id=xxx`（仅用 preview + is_paid） |
| MBTI 完整报告页 | `GET /mbti/report?result_id=xxx`（is_paid 为 true 时展示 full_content） |
| 支付页 | `POST /order/create`，跳转返回的 `pay_url` |
| 我的测试记录 | `GET /user/results` 或 `GET /mbti/my-results`（可选 v1.0） |

---

## 八、相关文档

| 文档 | 说明 |
|------|------|
| [数据库设计](./数据库设计.md) | 表结构、**MBTI 测试逻辑**（计分与报告数据流）、评分规则说明 |
| [CSV与表结构说明](./CSV与表结构说明.md) | 各 CSV 与表列对应、导入顺序 |
| [前端开发文档](./前端开发文档.md) | 请求封装、调用示例、页面与路由 |
| [后端开发文档](./后端开发文档.md) | 后端实现与对接细节 |
