# 《发现你的天赋优势》后端开发文档

> 本文档供在**单独后端项目目录**下开发使用，仅描述结构、接口、数据库与业务逻辑，不包含具体代码实现。技术栈：Laravel + dcat-admin + MySQL 5.7。**表结构以《数据库设计》为准**：表名统一以 **strengths_** 为前缀（如 strengths_test_types、strengths_orders）；关联用 **test_type**（存 code，如 MBTI），测试答案表 **strengths_test_answer**，用户测试记录表 **strengths_test_results_records**，无 JSON。

---

## 一、项目定位与约定

- **职责**：提供 API（测试类型、题目、提交答案、报告、订单与支付回调），管理后台（dcat-admin）维护题目、结果、价格等。
- **Base Path**：`/api/v1`，与前端 request.js 的 baseUrl 一致。
- **响应格式**：成功 `code: 200, msg: "success", data: {...}`；业务错误 `code >= 10000, msg: "错误说明"`。
- **认证**：v1.0 匿名答题可不强制登录；支付与防重复付费依赖 openid 或 session，由后端从请求/回调中获取并写入 **strengths_test_results_records**、**strengths_orders**。

---

## 二、数据库与建表（在另一目录执行）

### 2.1 建表脚本（本仓库 database/建表脚本.sql）

- 本仓库提供 **MySQL 建表脚本** `database/建表脚本.sql`，包含全部 **10 张表**（表名统一以 strengths_ 为前缀）：
  - strengths_test_types（含 price）、strengths_test_scoring_rules、**strengths_test_questions_section**（题目分组）
  - strengths_test_questions、**strengths_test_question_options**
  - **strengths_test_dimensions**（四个维度）、**strengths_test_dimension_sides**（八个面）
  - **strengths_test_answer**（测试答案，MBTI十六种性格类型等）
  - **strengths_test_results_records**（用户测试记录）、strengths_orders
- 各业务表用 **test_type**（varchar，存 strengths_test_types.code，如 MBTI）关联测试类型，不用 test_type_id。
- 建表说明、字段说明、**MBTI 测试逻辑**（计分与报告数据流）见 [数据库设计](./数据库设计.md)。

### 2.2 数据来源与导入

- **MBTI 数据**：来自本仓库 `素材/MBTI题库和答案/` 下 CSV，**不使用 JSON**，可用 Navicat 直接导入：
  - 01-测试类型.csv → strengths_test_types（表含 price 默认 8.88）
  - 01-计分规则.csv → strengths_test_scoring_rules（**test_type** 存 MBTI/HOLLAND 等）
  - 02-题目类型.csv → strengths_test_questions_section（分组→section_code，题目标题→section_title，是否有题目→has_questions；需补 test_type）
  - 02-题目-题目.csv → strengths_test_questions（需补 test_type、section_code）
  - 02-题目-题目选项.csv → strengths_test_question_options（需补 test_type；dimension_side：E/I/S/N/T/F/J/P）
  - 03-答案-MBTI的四个维度.csv → **strengths_test_dimensions**（需补 test_type=MBTI；维度代码→dimension_code，维度方面→dimension_aspect，维度特质对→dimension_trait_pair）
  - 03-答案-四个维度八个面.csv → **strengths_test_dimension_sides**（需补 test_type=MBTI；维度代码→dimension_code，面代码→side_code，面名称→side_name）
  - 03-答案-十六种性格类型.csv → **strengths_test_answer**（一张表，需补 test_type=MBTI）
- **计分规则**：MBTI 计分按 **strengths_test_question_options.dimension_side** 汇总四维得分，同分规则见《数据库设计》中「评分规则说明」。
- 详细列对应与导入顺序见 [CSV与表结构说明](./CSV与表结构说明.md)。

---

## 三、接口与路由（概要）

以下路由均挂在 `api/v1` 下，建议使用 `Route::prefix('api/v1')->group(...)`。

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /test-types/list | 测试类型列表（含 price、is_available） |
| GET | /test-types/detail | 详情（code=MBTI），说明页用 |
| GET | /mbti/intro | MBTI 说明（可合并到 test-types/detail） |
| GET | /mbti/questions | MBTI 题目列表（选项从 strengths_test_question_options 按题组装） |
| POST | /mbti/submit | 提交答案，计分并生成/更新 strengths_test_results_records，返回 result_id、result_code、预览内容、is_paid |
| GET | /mbti/report | 报告详情（result_id），按 is_paid 从 strengths_test_answer 返回部分或完整内容 |
| POST | /order/create | 创建订单（入参 result_id），返回 pay_url（易支付） |
| GET | /order/status | 订单/是否已付费（可选，报告接口已含 is_paid 时可省略） |

- **易支付回调**：单独路由（如 POST /payment/epay/notify），不对外暴露给前端，仅接收易支付异步通知，校验签名后更新 strengths_orders、strengths_test_results_records.is_paid。

---

## 四、业务逻辑概要（与《数据库设计》MBTI 测试逻辑一致）

### 4.1 测试类型列表

- 查询 **strengths_test_types** 且 `status=1`，按 sort 排序；返回 id、code、name、description、total_questions、price、sort、status。
- `is_available`：v1.0 仅 **code=MBTI** 为 true，其余为 false，可由后端写死或配置表扩展。

### 4.2 MBTI 题目列表

- 查询 **strengths_test_questions** 其中 **test_type='MBTI'**，按 question_number 排序。
- 选项从 **strengths_test_question_options** 按 `(test_type, section_code, question_number)` 组装：每题为多行（option_key、option_text），返回给前端为 options 数组（key、text 即可，计分在后端用 dimension_side）。
- 返回 id、question_number、question_text、options（数组）。

### 4.3 MBTI 提交答案与计分

- 接收 answers（题目与选项对应，如 question_number + option_key）。
- 对每条答案，用 **test_type=MBTI** + section_code + question_number + option_key 在 **strengths_test_question_options** 中取该选项的 **dimension_side**（E/I/S/N/T/F/J/P）。
- 按四个维度（E-I、S-N、T-F、J-P）汇总各端得分：E vs I、S vs N、T vs F、J vs P；**同分时**按《数据库设计》「评分规则说明」取 I、N、F、P。
- 组合成 4 字母 **result_code**（如 INTJ）。
- 写入或更新 **strengths_test_results_records**：**test_type='MBTI'**，**result_code**，同一 openid/session + test_type 若已有未付费记录可更新该条；否则新增；is_paid=0。
- 用 **(test_type, result_code)** 查 **strengths_test_answer** 取 result_name 等；返回 result_id、result_code、result_name、is_paid。

### 4.4 报告详情

- 根据 **result_id** 查 **strengths_test_results_records**，得 test_type、result_code、is_paid。
- 用 **(test_type, result_code)** 查 **strengths_test_answer** 取一行（summary、traits、strengths、weaknesses、careers 等）。
- 若 strengths_test_results_records.is_paid=1，返回完整内容；否则仅返回部分内容及 price（从 strengths_test_types 按 code=test_type 取）。

### 4.5 创建订单与支付

- 根据 **result_id** 查 strengths_test_results_records，校验未付费、归属（openid/session）；取 **test_type**，从 **strengths_test_types** 按 code=test_type 取 **price** 作为金额。
- 生成 out_trade_no，写入 **strengths_orders**（test_result_id、**test_type**、amount、status=pending），调用易支付接口获取 pay_url，返回给前端。
- 前端跳转 pay_url；用户支付成功后，易支付异步回调后端。
- 回调逻辑：校验签名、更新 strengths_orders.status=paid、strengths_orders.paid_at、**strengths_test_results_records.is_paid=1**、strengths_test_results_records.paid_at；可选重定向到前端报告页（带 result_id）。

### 4.6 防重复付费

- 同一 **openid + test_type** 下，若已有 is_paid=1 的 strengths_test_results_records 记录，则不再创建新订单，直接返回「已付费」或报告内容；提交答案时若已存在已付费结果，可返回该 result_id 供前端跳转报告。

---

## 五、管理后台（dcat-admin）

- **测试类型**：列表、编辑；字段含 code、name、description、total_questions、**price**、sort、status；表 **strengths_test_types**。
- **题目类型/分组**：表 **strengths_test_questions_section**；维护 section_code、section_title、has_questions；MBTI 下一/二/三/四，二、四可能无传统题目。
- **题目**：按 **test_type** 筛选，维护 question_text、section_code（题目分组代码）、question_number；选项在 **strengths_test_question_options** 表维护（option_key、option_text、dimension_side）。
- **计分规则**：按 **test_type** 维护 rule_name、rule_type、calculate_method、top_count；无 JSON。
- **四个维度 / 八个面**：**strengths_test_dimensions**、**strengths_test_dimension_sides** 按 test_type 维护（说明页、报告扩展用）；维度表含 dimension_code、dimension_aspect、dimension_trait_pair、dimension_scope、dimension_summary、dimension_narrative、dimension_context。
- **测试答案（十六种性格报告）**：维护 **strengths_test_answer**（test_type、result_code、result_name、summary、traits、strengths、weaknesses、careers、typical_figures 等）。
- **订单**：列表、筛选、状态展示；只读或仅允许关闭/退款等简单操作。

---

## 六、易支付对接要点（仅说明，不写代码）

- 商户号、密钥、回调 URL 等配置放在 `.env` 或 config。
- 创建订单时：组装参数（金额、订单号、通知 URL 等），请求易支付接口获取支付链接。
- 异步回调：接收 POST，验签，根据 out_trade_no 更新订单与 **strengths_test_results_records.is_paid**，返回成功响应给易支付（避免重复回调）。

---

## 七、与前端、接口文档的对应

- 接口路径、参数、响应格式以《接口文档》为准；本文档描述后端实现思路与表、逻辑对应关系。
- **MBTI 测试逻辑**（计分步骤、报告查询步骤、订单与防重复）以《数据库设计》中「MBTI 测试逻辑」为准。
- 前端调用方式见《前端开发文档》；数据库表结构见《数据库设计》。

---

## 八、开发顺序建议（在后端目录）

1. 建表：执行本仓库 `database/建表脚本.sql` 创建全部 10 张表。
2. 数据导入：按 [CSV与表结构说明](./CSV与表结构说明.md) 用 Navicat 导入 CSV（补 test_type 等列）。
3. 计分逻辑：按《数据库设计》「MBTI 测试逻辑」与「评分规则说明」实现（strengths_test_question_options.dimension_side 汇总 + 同分取 I/N/F/P）。
4. API：测试类型列表、题目列表（选项从 strengths_test_question_options 组装）、提交答案、报告详情（从 strengths_test_answer 查）、创建订单。
5. 易支付：创建订单跳转、异步回调更新订单与 strengths_test_results_records.is_paid。
6. dcat-admin：配置测试类型、**题目分组**、题目、题目选项、四个维度/八个面、**strengths_test_answer**、价格、订单等管理菜单与表单。

---

## 九、已实现接口与后台路由

### 9.1 API 路由（Base: `/api/v1`）

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /test-types/list | 测试类型列表 |
| GET | /test-types/detail?code=MBTI | 测试类型详情（说明页） |
| GET | /mbti/intro | MBTI 说明（同 detail?code=MBTI） |
| GET | /mbti/questions | MBTI 题目列表（含选项） |
| POST | /mbti/submit | 提交答案，计分并返回 result_id、result_code、preview_content、is_paid |
| GET | /mbti/report?result_id=xxx | 报告详情（按 is_paid 返回预览/完整） |
| POST | /order/create | 创建订单（body: result_id），返回 pay_url、out_trade_no（易支付已对接，配置见 [易支付配置说明](./易支付配置说明.md)） |
| GET | /order/status?result_id=xxx | 订单/是否已付费 |
| POST | /payment/epay/notify | 易支付异步通知（由易支付服务器 POST，验签后更新订单与 is_paid） |

以上接口均为匿名可访问（不强制登录）。

### 9.2 管理后台路由（Dcat Admin）

在 `app/Admin/routes.php` 中已注册以下资源路由（前缀以实际 admin 配置为准）：

| 资源 | uri | 说明 |
|------|-----|------|
| 测试类型 | strengths_test_types | 测试类型 CRUD（含 price、status） |
| 计分规则 | strengths_test_scoring_rules | 计分规则 |
| 题目分组 | strengths_test_questions_section | 题目标题/分组 |
| 题目 | strengths_test_questions | 题目 |
| 题目选项 | strengths_test_question_options | 选项（含 dimension_side） |
| 四个维度 | strengths_test_dimensions | MBTI 维度说明 |
| 八个面 | strengths_test_dimension_sides | 维度八个面说明 |
| 测试答案 | strengths_test_answer | 十六种性格报告内容 |
| 用户测试记录 | strengths_test_results_records | 只读列表+详情 |
| 订单 | strengths_orders | 只读列表+详情 |

**添加左侧菜单**：登录后台后打开 `http://你的域名/admin/auth/menu`，新增菜单项，**uri** 填上表「uri」列中的值（如 `strengths_test_types`），标题可填「测试类型」「题目分组」等。

---

## 十、相关文档

| 文档 | 说明 |
|------|------|
| [数据库设计](./数据库设计.md) | 表结构、**MBTI 测试逻辑**（计分与报告数据流）、评分规则说明 |
| [CSV与表结构说明](./CSV与表结构说明.md) | 各 CSV 与表列对应、导入顺序 |
| [接口文档](./接口文档.md) | 请求/响应格式与路径 |
| [前端开发文档](./前端开发文档.md) | 前端调用方式与页面 |
| [建表脚本](./database/建表脚本.sql) | MySQL 建表 SQL（10 张 strengths_ 表） |
| [易支付配置说明](./易支付配置说明.md) | 易支付 .env 配置、签名与回调说明 |
