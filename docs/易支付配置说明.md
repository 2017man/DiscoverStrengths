# 易支付对接配置说明

本项目已按 **docs/易支付开发文档.md** 完成对接，**个人配置均通过 .env 预留**。

---

## 一、.env 配置项（与开发文档一致）

在项目根目录 `.env` 中增加或修改以下项（值请到易支付后台获取）：

| 变量名 | 说明 | 示例 |
|--------|------|------|
| EPAY_ENABLED | 是否启用易支付（true/false） | true |
| EPAY_MCH_ID | 商户 id（文档 mchId） | 1547130349673 |
| EPAY_KEY | 通讯密钥（签名与验签） | xxxxx |
| EPAY_API_CREATE_ORDER | 创建订单接口地址（文档示例） | https://epay.jylt.cc/api/createOrder |
| EPAY_NOTIFY_URL | 异步通知地址（支付成功后易支付 **GET** 到此地址，须公网可访问） | https://你的域名/api/v1/payment/epay/notify |
| EPAY_RETURN_URL | 同步跳转地址（isHtml=1 时支付完成后浏览器跳转，可选） | https://your-h5.com/#/report |
| EPAY_RETURN_URL_BASE | 前端报告页基础 URL（未填 EPAY_RETURN_URL 时拼接 ?result_id=xxx） | https://your-h5.com/#/report |
| EPAY_TYPE | 支付方式（文档 type）：1=微信 2=支付宝 | 2 |
| EPAY_IS_HTML | 0=返回订单 json（含 payUrl）；1=返回跳转页面 url | 0 |
| EPAY_API_GET_ORDER | 【可选】查询订单信息接口；不填则从 EPAY_API_CREATE_ORDER 同域名派生 /api/getOrder | （留空自动派生） |
| EPAY_API_CHECK_ORDER | 【可选】查询订单状态接口；不填则从 EPAY_API_CREATE_ORDER 同域名派生 /api/checkOrder | （留空自动派生） |
| PAYMENT_SKIP_FOR_TEST | **测试阶段免支付**：为 true 时创建订单不调用易支付，直接视为已支付并返回报告页地址（仅用于测试环境，生产务必设为 false） | false |

**注意**：

- `EPAY_NOTIFY_URL` 必须为 **公网可访问** 的完整 URL；易支付文档规定为 **GET** 请求。
- 回调接口收到请求后必须返回字符串 **"success"**，否则易支付会提示“通知失败”。
- 若此前使用过旧版配置（EPAY_PID、EPAY_API_URL 等），请改为 **EPAY_MCH_ID**、**EPAY_API_CREATE_ORDER**，并设置 **EPAY_TYPE** 为整数 1 或 2。

---

## 二、接口与签名（与开发文档一致）

### 2.1 创建订单

- **请求**：后端请求易支付 `POST /api/createOrder`，参数：mchId、payId、type、price、sign、goodsName、param、isHtml、notifyUrl、returnUrl。
- **签名（创建订单）**：`sign = md5(payId+param+type+price+通讯密钥)`（字符串直接拼接后 MD5，小写）。
- **返回**：code=1 时 data 含 payUrl（或 isHtml=1 时为跳转 url）；前端用该 payUrl 展示二维码或跳转。

### 2.2 查询订单信息（getOrder）与查询订单状态（checkOrder）

- **getOrder**：请求易支付 `GET/POST /api/getOrder`，参数 orderId、mchId；返回订单详情（payUrl、state 等）。
- **checkOrder**：请求易支付 `GET/POST /api/checkOrder`，参数 orderId、mchId；返回 code：1=已支付，-1=失败，-2=未支付，-3=已过期。
- 创建订单成功后，本系统会保存易支付返回的 **orderId** 到 `strengths_orders.epay_order_id`，供轮询使用。
- 前端或后端可调用 **GET /api/v1/order/check-payment?out_trade_no=xxx** 轮询支付状态；后端会调用易支付 checkOrder，若已支付则同步更新本地订单与测试记录并返回 paid: true。

### 2.3 异步通知（回调）

- **请求**：易支付向 `EPAY_NOTIFY_URL` 发送 **GET** 请求。
- **参数**：mchId、payId、orderId、param、type、price、reallyPrice、sign。
- **验签**：`sign = md5(orderId+param+type+price+reallyPrice+通讯密钥)`（字符串直接拼接后 MD5）。
- **逻辑**：验签通过后根据 **payId**（商户支付单号，即本系统 `out_trade_no`）查单，更新订单状态与 `strengths_test_results_records.is_paid`，并返回纯文本 **"success"**。
- **去重**：已处理过的订单（status=paid）直接返回 success，避免重复通知；文档说明易支付最多 7 次确认通知。

---

## 三、测试阶段免支付

当在 `.env` 中设置 **PAYMENT_SKIP_FOR_TEST=true** 时：

- **创建订单**（`POST /api/v1/order/create`）：不请求易支付接口，订单与测试记录会立即标记为已支付（`strengths_orders.status=paid`、`strengths_test_results_records.is_paid=1`）。
- **返回数据**：`pay_url` 为前端报告页地址（由 `EPAY_RETURN_URL_BASE` 拼接 `?result_id=xxx`）；响应中增加 `skip_payment: true`，前端可据此直接跳转报告页或提示「测试模式已免支付」。
- **适用场景**：仅用于开发/联调/演示环境，无需真实支付即可走通「下单 → 报告」流程。**生产环境必须设为 false 或删除该变量。**

---

## 四、相关文件

| 文件 | 说明 |
|------|------|
| docs/易支付开发文档.md | 易支付官方开发文档（创建订单、查询订单、查询状态、生成签名、回调参数） |
| config/epay.php | 易支付配置（均从 .env 读取） |
| .env / .env.example | 个人配置项（EPAY_*） |
| app/Http/Service/EpayService.php | 创建订单请求、签名、回调验签与处理 |
| app/Http/Controllers/Api/OrderController.php | 创建订单时调用 EpayService::createOrder 获取 pay_url，并保存 epay_order_id；提供 GET /api/v1/order/check-payment 轮询支付状态 |
| app/Http/Controllers/Api/PaymentController.php | 易支付异步通知入口 GET /api/v1/payment/epay/notify |

---

## 五、对照检查清单（与易支付开发文档.md）

| 文档项 | 本项目实现 |
|--------|------------|
| 创建订单地址 | config epay.api_create_order，请求 POST 该地址 |
| 参数 mchId、payId、type、price、sign、goodsName | EpayService::createOrder 已传，goodsName 截断 50 字 |
| 签名 md5(payId+param+type+price+通讯密钥) | EpayService::buildCreateOrderSign |
| notifyUrl、returnUrl、isHtml、param | 已传，param 传 result_id 便于对账 |
| 返回 data.payUrl、\u003d 替换为 = | 已取 payUrl 并替换 |
| 回调 GET、参数 payId/orderId/param/type/price/reallyPrice/sign | PaymentController 接收 GET，EpayService::handleNotify 用 request()->all() |
| 回调验签 md5(orderId+param+type+price+reallyPrice+通讯密钥) | EpayService::buildNotifySign、verifyNotifySign |
| 根据 payId 更新订单、返回 "success" | handleNotify 按 payId 查 out_trade_no，更新后 return response('success') |
| 查询订单 getOrder / 查询状态 checkOrder | EpayService::getOrder(orderId)、checkOrder(orderId)；URL 可由 api_create_order 派生 |
| 轮询支付状态 | GET /api/v1/order/check-payment?out_trade_no=xxx 调用 checkOrder，已支付时同步更新本地并返回 paid: true |
