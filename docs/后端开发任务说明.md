# 后端开发任务说明

> 本文档汇总《发现你的天赋优势》H5 项目后端需完成的全部工作，可直接复制「AI 提示词」章节给 AI 执行。

---

## 一、技术栈与约定

- **技术栈**：Laravel + dcat-admin + MySQL 5.7
- **Base Path**：`/api/v1`
- **统一响应**：成功 `{ "code": 200, "msg": "success", "data": { ... } }`；业务错误 `{ "code": 10000+, "msg": "错误说明" }`
- **表前缀**：`strengths_`；关联用 `test_type` 存 code（如 MBTI）；维度代码：`E-I`、`S-N`、`T-F`、`J-P`

---

## 二、数据库

### 2.1 执行建表脚本

1. 执行 `docs/database/建表脚本.sql`（含 11 张表）
2. 已有库升级：执行脚本末尾「变更/迁移」部分的 ALTER（取消注释后执行）

### 2.2 新增/补充内容（脚本已包含）

| 表/字段 | 说明 |
|---------|------|
| `strengths_site_config` | 站点配置：stats_count、stats_date、qrcode_wechat、qrcode_community |
| `strengths_test_types.estimate_minutes` | 建议答题时长（分钟） |
| `strengths_test_answer.suggestion` | 沟通与成长建议 |

### 2.3 strengths_site_config 初始数据

建议插入一条记录，供 `GET /config/site` 使用：

```sql
INSERT INTO `strengths_site_config` (`stats_count`, `stats_date`, `qrcode_wechat`, `qrcode_community`) 
VALUES ('0', '2014年5月19日 ~ 至今', NULL, NULL);
```

---

## 三、必须实现的接口（按优先级）

### P0：核心闭环

| 接口 | 路径 | 说明 |
|------|------|------|
| 站点配置 | `GET /config/site` | 返回 stats_count、stats_date、qrcode_wechat、qrcode_community，数据来源 `strengths_site_config` |
| 测试类型列表 | `GET /test-types/list` | 返回 strengths_test_types，含 price、is_available（v1.0 仅 MBTI 为 true） |
| MBTI 说明 | `GET /mbti/intro` | 返回 total_questions、estimate_minutes、price 等 |
| MBTI 题目 | `GET /mbti/questions` | 题目 + options + **sections**（section_code、section_title、sort） |
| 提交答案 | `POST /mbti/submit` | 计分、写入 strengths_test_results_records，返回 result_id、result_code、is_paid、preview_content |
| 报告详情 | `GET /mbti/report?result_id=xxx` | 已付费返回完整结构化字段；未付费返回 preview_content、price |
| **报告 full=1** | `GET /mbti/report?result_id=xxx&full=1` | **测试环境**：带 full=1 时，未付费也返回完整结构化字段 |
| **PDF 下载** | `GET /mbti/report/pdf?result_id=xxx` | 已付费返回 PDF 文件流（Content-Type: application/pdf），未付费 403 |
| 创建订单 | `POST /order/create` | body: `{ result_id }`，返回 pay_url（易支付）或 skip_payment: true |
| 支付回调 | 易支付异步通知 | 验签后更新 strengths_orders、strengths_test_results_records.is_paid |

### P1：报告接口字段要求

`GET /mbti/report` 已付费时需返回（详见接口文档 4.2）：

- `dimension_scores`：由 e_score～p_score 计算百分比，每维度 leftScore + rightScore = 100
- `dimension_sides`：来自 strengths_test_dimension_sides，8 条
- `dimensions`：来自 strengths_test_dimensions，dimension_scope 作第 2 部分标题
- `dimensions_detail`：可选，含 leftCode/rightCode、leftScore/rightScore、leftName/rightName、leftOverview/rightOverview、leftFeatures/rightFeatures、leftKeywords/rightKeywords、leftExpression/rightExpression、leftMantra/rightMantra
- `traits_summary`、`traits`、`suggestion`：来自 strengths_test_answer
- `strengths`、`weaknesses`：数组，可从 strengths_test_answer 对应 text 按分隔符解析
- `careers`、`typical_figures`：来自 strengths_test_answer

---

## 四、易出错点

1. **dimension_code** 必须为 `E-I`、`S-N`、`T-F`、`J-P`，不能用 `EI`、`SN`
2. **strengths、weaknesses** 必须为数组
3. **sections** 在 mbti/questions 根级返回，与 data 平级
4. **suggestion** 对应 strengths_test_answer 新增字段「沟通与成长建议」

---

## 五、相关文档

| 文档 | 用途 |
|------|------|
| `docs/接口文档.md` | 完整接口规范、请求/响应示例 |
| `docs/后端开发文档.md` | 业务逻辑、计分规则、PDF 生成指南 |
| `docs/database/建表脚本.sql` | 建表 SQL |
| `docs/易支付配置说明.md` | 易支付对接配置 |

---

## 六、AI 提示词（可直接复制）

```
请帮我完成《发现你的天赋优势》项目的后端开发。技术栈：Laravel + MySQL 5.7。

【必读文档】请先阅读项目中的以下文档：
- docs/接口文档.md
- docs/后端开发文档.md
- docs/database/建表脚本.sql

【数据库】
1. 执行 docs/database/建表脚本.sql 创建/更新表结构
2. 为 strengths_site_config 插入一条初始记录
3. 若已有库，执行脚本末尾的 ALTER 语句（estimate_minutes、suggestion、strengths_site_config 表）

【必须实现的接口】
1. GET /api/v1/config/site
   - 从 strengths_site_config 读取 stats_count、stats_date、qrcode_wechat、qrcode_community
   - 返回 { code: 200, msg: "success", data: { stats_count, stats_date, qrcode_wechat, qrcode_community } }

2. GET /api/v1/mbti/report?result_id=xxx
   - 支持可选参数 full=1：带 full=1 时，即使未付费也返回完整结构化字段（便于测试联调）
   - 已付费时返回：dimension_scores、dimension_sides、dimensions、dimensions_detail、traits_summary、traits、suggestion、strengths、weaknesses、careers、typical_figures
   - dimension_code 必须为 E-I、S-N、T-F、J-P
   - strengths、weaknesses 必须为数组

3. GET /api/v1/mbti/report/pdf?result_id=xxx
   - 已付费：返回 PDF 文件流，Content-Type: application/pdf，Content-Disposition: attachment
   - 未付费：返回 403

4. 其余接口按 docs/接口文档.md 实现：test-types/list、mbti/intro、mbti/questions、mbti/submit、order/create、支付回调

【PDF 生成】推荐 barryvdh/laravel-dompdf，详见 docs/后端开发文档.md
【易支付】详见 docs/易支付配置说明.md
```
