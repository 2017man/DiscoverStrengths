# 《发现你的天赋优势》数据库设计

## 一、设计原则

- **表名统一前缀**：所有业务表以 `strengths_` 为前缀，如 `strengths_test_types`、`strengths_orders`。
- **测试类型关联用 test_type**：各业务表用 `test_type`（varchar，存 `strengths_test_types.code`，如 MBTI、HOLLAND）直接关联测试类型，不用 test_type_id。
- **每个测试类型独立业务数据**：题目、计分规则、结果等按 `test_type` 区分，便于扩展霍兰德、DISC、职业锚。
- **价格在后台可配置**：`strengths_test_types` 表含 `price` 字段，前端与支付按该配置读取。
- **MBTI 数据来源**：题目与人格特点来自 `素材/MBTI题库和答案/` 下 CSV，**不使用 JSON**，可用 Navicat 直接导入；详见 [CSV与表结构说明](./CSV与表结构说明.md)。

---

## 二、表结构清单

| 表名 | 说明 |
|------|------|
| strengths_test_types | 测试类型（含 code、价格、是否可用）← 01-测试类型.csv |
| strengths_test_scoring_rules | 计分规则（按 test_type）← 01-计分规则.csv |
| strengths_test_questions_section | 题目分组（题目标题；MBTI 下不是每个分组都有题目）← 02-题目类型.csv（类型、题目标题、是否有题目） |
| strengths_test_questions | 题目表 ← 02-题目-题目.csv |
| strengths_test_question_options | 题目选项表（计分用）← 02-题目-题目选项.csv |
| strengths_test_dimensions | MBTI 四个维度说明 ← 03-答案-MBTI的四个维度.csv |
| strengths_test_dimension_sides | 四个维度八个面说明 ← 03-答案-四个维度八个面.csv |
| strengths_test_answer | 测试答案（MBTI十六种性格类型等测试结果的解释内容）← 03-答案-十六种性格类型.csv |
| strengths_test_results_records | 用户测试记录（由应用写入） |
| strengths_orders | 订单表（由应用写入） |

**说明**：04-评分规则.csv 内容不建表，以「评分规则说明」形式写在本文档中，便于开发查阅（见下文「评分规则说明」）。

---

## 三、建表脚本说明

- **脚本位置**：`database/建表脚本.sql`
- **适用**：MySQL 5.7+
- **字符集**：utf8mb4
- **用途**：一次性创建全部业务表；供在后端项目或本仓库直接执行建库。

### 3.1 执行前准备

1. 创建数据库（若尚未创建）：
   ```sql
   CREATE DATABASE IF NOT EXISTS discover_strengths DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   USE discover_strengths;
   ```
2. 库名统一使用 `discover_strengths`。

### 3.2 执行方式

**方式一：命令行**

```bash
mysql -u 用户名 -p discover_strengths < database/建表脚本.sql
```

**方式二：客户端**

在 Navicat、DBeaver、MySQL Workbench 等中打开 `database/建表脚本.sql`，选择目标数据库后执行全文。

**方式三：分段执行**

若需保留已有表、仅建缺失表，可只复制脚本中对应表的 `CREATE TABLE` 段落执行（注意表依赖顺序：先 strengths_test_types，再其余表）。

### 3.3 表创建顺序（脚本内已按此顺序）

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | strengths_test_types | 测试类型（含 price） |
| 2 | strengths_test_scoring_rules | 计分规则 |
| 3 | strengths_test_questions_section | 题目分组（题目标题） |
| 4 | strengths_test_questions | 题目 |
| 5 | strengths_test_question_options | 题目选项 |
| 6 | strengths_test_dimensions | MBTI 四个维度 |
| 7 | strengths_test_dimension_sides | 四个维度八个面 |
| 8 | strengths_test_answer | 测试答案（十六种性格类型等） |
| 9 | strengths_test_results_records | 用户测试记录 |
| 10 | strengths_orders | 订单 |

### 3.4 注意事项

- 脚本内含 `DROP TABLE IF EXISTS`，执行会**删除已存在的同名表**，请确认无重要数据或先在测试环境执行。

---

## 四、表结构及字段说明

### 4.1 strengths_test_types（测试类型）

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | int(10) unsigned | 非空，自增 | 主键 |
| code | varchar(20) | 非空，唯一 | 测试代码：MBTI / HOLLAND / ANCHOR / DISC，**作为 test_type 关联用** |
| name | varchar(50) | 非空 | 测试名称，如「MBTI 职业性格测试」 |
| description | text | 可空 | 测试说明正文，用于说明页展示 |
| total_questions | int(11) | 非空，默认 0 | 总题数 |
| price | decimal(10,2) | 非空，默认 8.88 | 单价（元），后台可配置，前端与支付按此读取 |
| sort | int(11) | 非空，默认 0 | 排序，数值越小越靠前 |
| status | tinyint(4) | 非空，默认 1 | 状态：1 启用 0 禁用 |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**索引**：`code`（唯一）、`code`、`status`。

---

### 4.2 strengths_test_scoring_rules（计分规则）

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | int(10) unsigned | 非空，自增 | 主键 |
| test_type | varchar(20) | 非空，唯一 | 测试类型代码，关联 strengths_test_types.code |
| rule_name | varchar(50) | 非空 | 规则名称，如「MBTI 维度计分」 |
| rule_type | varchar(20) | 非空 | 规则类型：dimension / type / anchor |
| calculate_method | varchar(50) | 可空 | 计算方法标识 |
| top_count | int(11) | 可空 | 取前 N 个类型（如霍兰德取 3） |
| description | text | 可空 | 规则说明 |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**索引**：`test_type`（唯一）、`test_type`。MBTI 计分按 **strengths_test_question_options.dimension_side** 汇总各维度得分，再组合成 16 型 result_code。具体规则见本文档「评分规则说明」。

---

### 4.3 strengths_test_questions_section（题目分组）

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | int(10) unsigned | 非空，自增 | 主键 |
| test_type | varchar(20) | 非空 | 测试类型代码，关联 strengths_test_types.code |
| section_code | varchar(20) | 非空 | 题目分组代码，如 一/二/三/四 |
| section_title | text | 可空 | 题目标题/引导语，如「哪一个答案最能贴切的描绘你一般的感受或行为?」 |
| has_questions | tinyint(4) | 非空，默认 1 | 该分组下是否有题目：1 有 0 无（如 MBTI 二、四为选词题，可能无传统题目） |
| sort | int(11) | 非空，默认 0 | 排序 |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**唯一**：`(test_type, section_code)`。**索引**：`test_type`。MBTI 下一、二、三、四四个分组均有题目标题，但二、四可能无传统题目（has_questions=0）。

---

### 4.4 strengths_test_questions（题目）

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | bigint(20) unsigned | 非空，自增 | 主键 |
| test_type | varchar(20) | 非空 | 测试类型代码，关联 strengths_test_types.code |
| section_code | varchar(20) | 可空 | 题目分组代码，关联 strengths_test_questions_section.section_code，如 一/二/三/四 |
| question_number | int(11) | 非空 | 题号，用于排序与展示 |
| question_text | text | 非空 | 题目内容 |
| sort | int(11) | 非空，默认 0 | 排序 |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**索引**：`(test_type, question_number)`、`test_type`。选项在 **strengths_test_question_options** 表，无 JSON。

---

### 4.5 strengths_test_question_options（题目选项，计分用）

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | bigint(20) unsigned | 非空，自增 | 主键 |
| test_type | varchar(20) | 非空 | 测试类型代码，关联 strengths_test_types.code |
| section_code | varchar(20) | 非空 | 题目分组代码，关联 strengths_test_questions_section.section_code |
| question_number | int(11) | 非空 | 题号，与 strengths_test_questions.question_number 对应 |
| option_key | varchar(10) | 非空 | 选项标签，如 A/B |
| option_text | text | 非空 | 选项内容 |
| dimension_side | varchar(2) | 非空 | 对应八个面之一：E / I / S / N / T / F / J / P |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**索引**：`(test_type, section_code, question_number)`、`test_type`。无 JSON，Navicat 可从 CSV 直接导入。

---

### 4.6 strengths_test_dimensions（MBTI 四个维度）← 03-答案-MBTI的四个维度.csv

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | int(10) unsigned | 非空，自增 | 主键 |
| test_type | varchar(20) | 非空 | 测试类型代码，如 MBTI |
| dimension_code | varchar(20) | 非空 | 维度代码：E-I/S-N/T-F/J-P |
| dimension_aspect | varchar(50) | 非空 | 维度方面：动力、信息收集、决策方式、做事方式 |
| dimension_trait_pair | varchar(50) | 非空 | 维度特质对：内向/外向、感觉/直觉、思考/情感、判断/感知 |
| dimension_scope | varchar(100) | 可空 | 该维度的主题/范畴（一句话界定），如「与世界的相互作用方式」「获取信息的主要方式」 |
| dimension_summary | text | 可空 | 一句话概括或核心提问，如「将注意力集中在何处，从哪里获得动力」 |
| dimension_narrative | text | 可空 | 该维度的详细说明正文（含两端特质对比） |
| dimension_context | text | 可空 | 延伸说明或背景语境（可选，部分维度有；如「如果只能用一个维度区分人……」） |
| sort | int(11) | 非空，默认 0 | 排序 |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**索引**：`test_type`、`dimension_code`。

---

### 4.7 strengths_test_dimension_sides（四个维度八个面）← 03-答案-四个维度八个面.csv

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | int(10) unsigned | 非空，自增 | 主键 |
| test_type | varchar(20) | 非空 | 测试类型代码，如 MBTI |
| dimension_code | varchar(20) | 非空 | 维度代码：E-I/S-N/T-F/J-P，关联 strengths_test_dimensions.dimension_code |
| side_code | varchar(2) | 非空 | 面代码：E/I/S/N/T/F/J/P |
| side_name | varchar(50) | 非空 | 面名称：外向、内向、感觉、直觉、思考、情感、判断、感知 |
| name_en | varchar(50) | 可空 | 英文名 |
| overview | text | 可空 | 概述 |
| features | text | 可空 | 特点 |
| keywords | text | 可空 | 关键词 |
| style | text | 可空 | 行为风格倾向 |
| expression | text | 可空 | 外在表现 |
| mantra | varchar(200) | 可空 | 口头禅 |
| sort | int(11) | 非空，默认 0 | 排序 |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**索引**：`test_type`、`dimension_code`、`side_code`。

---

### 4.8 strengths_test_answer（测试答案）← 03-答案-十六种性格类型.csv

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | int(10) unsigned | 非空，自增 | 主键 |
| test_type | varchar(20) | 非空 | 测试类型代码，如 MBTI |
| result_code | varchar(50) | 非空 | 结果代码，如 ISTJ、ENFP |
| result_name | varchar(100) | 非空 | 角色/结果名称，如 检查者、照顾者 |
| summary | varchar(200) | 可空 | 总括 |
| traits_summary | varchar(200) | 可空 | 性格特点总括 |
| traits | text | 可空 | 性格特点正文 |
| strengths | text | 可空 | 优势 |
| weaknesses | text | 可空 | 劣势 |
| careers | text | 可空 | 适合的职业 |
| typical_figures | varchar(200) | 可空 | 典型人物 |
| sort | int(11) | 非空，默认 0 | 排序 |
| status | tinyint(4) | 非空，默认 1 | 状态：1 启用 0 禁用 |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**唯一**：`(test_type, result_code)`。**索引**：`test_type`、`result_code`。存储测试结果的解释内容（MBTI十六种性格类型等），无 JSON，Navicat 可从 CSV 直接导入。

---

### 4.9 strengths_test_results_records（用户测试记录）

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | bigint(20) unsigned | 非空，自增 | 主键 |
| test_type | varchar(20) | 非空 | 测试类型代码，关联 strengths_test_types.code |
| result_code | varchar(50) | 非空 | 结果代码（如 INTJ），对应 strengths_test_answer.result_code |
| openid | varchar(64) | 可空 | 微信 openid，用于防重复付费与订单关联 |
| session_id | varchar(64) | 可空 | 匿名会话标识，无 openid 时使用 |
| answers_snapshot | text | 可空 | 答案快照（可选），存文本格式，便于复现或审计 |
| is_paid | tinyint(4) | 非空，默认 0 | 是否已付费：0 否 1 是 |
| paid_at | timestamp | 可空 | 付费时间 |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**索引**：`test_type`、`openid`、`(openid, test_type)`。防重复付费：同一 openid + test_type 下仅允许一条 is_paid=1（或业务上约定同人同类型只付一次）。报告内容通过 test_type + result_code 关联 **strengths_test_answer** 查询。

---

### 4.10 strengths_orders（订单）

| 字段名 | 类型 | 空/默认 | 说明 |
|--------|------|---------|------|
| id | bigint(20) unsigned | 非空，自增 | 主键 |
| out_trade_no | varchar(64) | 非空，唯一 | 商户订单号，对接易支付时使用 |
| test_result_id | bigint(20) unsigned | 非空 | 关联 strengths_test_results_records.id |
| test_type | varchar(20) | 非空 | 测试类型代码 |
| openid | varchar(64) | 可空 | 微信 openid |
| amount | decimal(10,2) | 非空 | 金额（元），一般与 strengths_test_types.price 一致 |
| status | varchar(20) | 非空 | 订单状态：pending / paid / failed / closed |
| pay_channel | varchar(20) | 可空 | 支付渠道，如 epay |
| paid_at | timestamp | 可空 | 支付成功时间（易支付回调时更新） |
| created_at | timestamp | 可空 | 创建时间 |
| updated_at | timestamp | 可空 | 更新时间 |

**索引**：`out_trade_no`（唯一）、`test_result_id`、`openid`。

---

## 五、评分规则说明（开发用）

以下内容来自 `素材/MBTI题库和答案/04-评分规则.csv`，**不建表**，放在数据库设计文档中便于后端/前端实现计分与同分处理时查阅。

### 5.1 评分规则

1. 当你将●涂好后，把 8 项（E、I、S、N、T、F、J、P）分别加起来，并将总和填在每项最下方的方格内。
2. 请复查你的计算是否准确，然后将各项总分填在下面对应的方格内。

### 5.2 确定类型的规则

1. **MBTI 以四个组别来评估你的性格类型倾向**：「E-I」「S-N」「T-F」和「J-P」。请你比较四个组别的得分。每个子别中，获得**较高分数**的那个类型，就是你的性格类型倾向。  
   **示例**：你的得分是 E（外向）12 分，I（内向）9 分，那你的类型倾向便是 **E**（外向）。
2. 将代表获得较高分数的类型的英文字母，填在下方的方格内。**如果在一个组别中，两个类型获同分**，则依据下边表格中的规则来决定你的类型倾向。

### 5.3 同分处理规则

| 情况 | 请填上 |
|------|--------|
| 假如 E = I | **I** |
| 假如 S = N | **N** |
| 假如 T = F | **F** |
| 假如 J = P | **P** |

**开发实现建议**：在计分逻辑中，对每个维度（EI、SN、TF、JP）先汇总 E/I、S/N、T/F、J/P 得分；若两端分数相等，则按上表取右侧一列（I、N、F、P）；否则取分数高的一端。最后将四个字母组合成 result_code（如 INTJ）。

---

## 六、MBTI 测试逻辑（开发必读）

本节说明从「用户答题」到「报告展示」的完整数据流与涉及表，便于后端/前端实现时与表结构对齐。

### 6.1 整体数据流

```
用户进入答题页 → 拉取题目（strengths_test_questions + strengths_test_question_options 组装选项）
→ 用户提交答案（题目与选项对应，如 question_number + option_key）
→ 后端计分：按选项查 dimension_side，四维汇总，同分取 I/N/F/P，得到 result_code（如 INTJ）
→ 写入或更新 strengths_test_results_records（test_type=MBTI, result_code, openid/session_id, is_paid=0）
→ 报告内容从 strengths_test_answer 按 test_type + result_code 查询一行
→ 未付费返回部分内容；付费后返回完整内容
→ 创建订单：result_id → strengths_test_results_records → test_type、金额从 strengths_test_types.price 读取
→ 支付回调：更新 strengths_orders、strengths_test_results_records.is_paid=1
```

### 6.2 涉及表与用途

| 表名 | 用途 |
|------|------|
| strengths_test_types | 测试类型列表、价格；关联用 code（即 test_type=MBTI） |
| strengths_test_scoring_rules | MBTI 一条，rule_type=dimension；同分规则见本文「评分规则说明」 |
| strengths_test_questions_section | 题目分组，存 section_code（一/二/三/四）、section_title、has_questions；MBTI 下二、四可能无传统题目 |
| strengths_test_questions | 题目列表，test_type=MBTI，section_code 关联 section；按 question_number 排序；无选项 JSON，选项在下一张表 |
| strengths_test_question_options | 每题 2 行（A/B），每行有 dimension_side（E/I/S/N/T/F/J/P）；计分时按用户选的 option_key 取该题的 dimension_side 计入对应维度 |
| strengths_test_answer | 16 型报告内容，每型一行；(test_type, result_code) 唯一；报告预览/完整均查此表 |
| strengths_test_results_records | 用户每次提交答案生成或更新一条；存 test_type、result_code、openid/session_id、is_paid；报告接口用 result_id 查此表再查 strengths_test_answer |
| strengths_orders | 订单，关联 test_result_id；支付回调更新订单与 strengths_test_results_records.is_paid |

### 6.3 计分步骤（后端实现要点）

1. **入参**：`test_type=MBTI`，`answers` 为题目与选项对应（如 `[{ "question_number": 1, "option_key": "A" }, ...]`）。
2. **按题取 dimension_side**：对每条答案，用 `(test_type, section_code, question_number, option_key)` 在 **strengths_test_question_options** 中查到该选项的 **dimension_side**（单字母 E/I/S/N/T/F/J/P）。
3. **四维汇总**：将 E 与 I 归入维度 E-I、S 与 N 归入 S-N、T 与 F 归入 T-F、J 与 P 归入 J-P，分别统计各端得分。
4. **确定四字母**：每个维度取得分高的一端；若同分则按「评分规则说明」取 I、N、F、P。得到四字母如 I、N、T、J。
5. **组合 result_code**：按维度顺序（E-I→第1字母，S-N→第2字母，T-F→第3字母，J-P→第4字母）拼成 **result_code**，如 INTJ。
6. **写入 strengths_test_results_records**：`test_type=MBTI`，`result_code=INTJ`，同一 openid/session + test_type 若已有未付费记录可更新该条，否则新增；`is_paid=0`。
7. **返回**：result_id、result_code、result_name（从 strengths_test_answer 取）、is_paid。

### 6.4 报告查询步骤

1. 入参：`result_id`。
2. 查 **strengths_test_results_records** 得 `test_type`、`result_code`、`is_paid`。
3. 用 `(test_type, result_code)` 查 **strengths_test_answer** 得一行（summary、traits、strengths、weaknesses、careers 等）。
4. 若 `is_paid=1` 返回完整内容；否则仅返回部分内容与 price（从 strengths_test_types 按 test_type 取）。

### 6.5 订单与防重复付费

- **创建订单**：入参 `result_id`，查 strengths_test_results_records 得 test_type、校验未付费、归属；金额从 strengths_test_types 按 code=test_type 取 price；写 strengths_orders 表，test_result_id、test_type、amount。
- **防重复付费**：同一 **openid + test_type** 下若已有 strengths_test_results_records.is_paid=1，则不再创建新订单，可直接返回「已付费」或跳转报告；提交答案时若该用户该类型已付费，可返回已有 result_id。

---

## 七、MBTI 数据与素材对应关系（无 JSON，Navicat 导入）

- **01-测试类型.csv** → `strengths_test_types`（表含 price 默认 8.88，CSV 无此列亦可）。注意：关联用 **code**，即 test_type 存 MBTI、HOLLAND 等。
- **01-计分规则.csv** → `strengths_test_scoring_rules`（列 **test_type** 存 strengths_test_types.code，如 MBTI）。
- **02-题目类型.csv** → `strengths_test_questions_section`（类型→section_code，题目标题→section_title，是否有题目→has_questions；需补 test_type）。
- **02-题目-题目.csv** → `strengths_test_questions`（需补 **test_type**、section_code，见 CSV 说明）。
- **02-题目-题目选项.csv** → `strengths_test_question_options`（需补 **test_type**；选项与计分用 dimension_side：E/I/S/N/T/F/J/P）。
- **03-答案-MBTI的四个维度.csv** → `strengths_test_dimensions`（需补 test_type=MBTI；维度方面→dimension_aspect，维度特质对→dimension_trait_pair，维度代码→dimension_code）。
- **03-答案-四个维度八个面.csv** → `strengths_test_dimension_sides`（需补 test_type=MBTI；维度代码→dimension_code，面代码→side_code，面名称→side_name）。
- **03-答案-十六种性格类型.csv** → **一张表** `strengths_test_answer`（需补 test_type=MBTI；类型→result_code，角色→result_name，总括→summary，其余列一一对应）。
- **04-评分规则.csv** → 不建表，内容见本文档「五、评分规则说明」。

详细列对应与导入顺序见 **[CSV与表结构说明](./CSV与表结构说明.md)**。

---

## 八、相关文档

| 文档 | 说明 |
|------|------|
| [数据库建表脚本](../database/建表脚本.sql) | 无 JSON 的建表 SQL，关联用 test_type，适配 Navicat 导入 |
| [CSV与表结构说明](./CSV与表结构说明.md) | 各 CSV 与表列对应、导入顺序 |
| [接口文档](./接口文档.md) | 接口与字段对应 |
| [后端开发文档](./后端开发文档.md) | 计分逻辑（按 strengths_test_question_options.dimension_side + 同分规则） |
